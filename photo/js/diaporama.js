/**
 * Gestion complète du diaporama.
 *
 * @license http://www.gnu.org/licenses/gpl.html
 * @link http://www.igalerie.org/
 */
function Diaporama()
{
	// Activer les animations par défaut ?
	this.animate = true;

	// Durée d'affichage par défaut d'une image en lecture automatique.
	// En secondes.
	this.autoDuration = 5.0;

	// Durée d'affichage minimale des images en lecture automatique.
	// En secondes.
	this.autoDurationMin = 1;

	// Durée d'affichage maximale des images en lecture automatique.
	// En secondes.
	this.autoDurationMax = 60;

	// Précision pour la durée d'affichage des images en lecture automatique.
	// En secondes.
	this.autoDurationPrecision = 0.5;

	// En lecture automatique, recommencer la lecture depuis
	// la première image lorsqu'on est arrivé à la dernière ?
	this.autoLoop = false;

	// Démarrer la lecture automatique au lancement du diaporama ?
	this.autoStart = false;

	// Afficher par défaut le carrousel ?
	this.carousel = true;

	// Épaisseur de la bordure du haut du carrousel.
	this.carouselBorderTop = 2;

	// Durée de l'effet de transition entre les pages du carrousel.
	this.carouselNavDuration = 600;

	// Marge externe des vignettes du carrousel.
	this.carouselThumbsMargin = 8;

	// Épaisseur de la bordure des vignettes du carrousel.
	this.carouselThumbsBorder = 1;

	// Dimensions des vignettes du carrousel.
	// En pixels (valeur minimale: 50).
	this.carouselThumbsSize = 80;

	// Durée de temporisation, en millisecondes, avant la création
	// de chaque image préchargée au lancement du diaporama.
	// Plus le paramètre MySQL 'max_user_connections' est petit,
	// plus cette durée doit être grande.
	// Si 'max_user_connections' est à 0,
	// alors 'createImageTempTime' peut être à 0.
	this.createImageTempTime = 400;

	// Cacher les barres de contrôle par défaut ?
	this.hideControlBars = false;

	// Durée de l'effet de redimensionnement de l'image
	// pour le switch taille réelle / taille redimensionnée.
	// 0 pour désactiver l'animation.
	// En millisecondes.
	this.imageResizeDuration = 250;

	// Autoriser la navigation au clavier ?
	this.keyboardNav = true;

	// Nombre d'images autour de l'image courante
	// (premières, précédentes, suivantes, dernières)
	// à récupérer depuis diaporama.php.
	this.preload = 2;

	// La sidebar doit-elle ne pas masquer l'image ?
	this.sidebarImageResize = true;

	// Durée de l'effet d'apparition des sidebars.
	// 0 pour désactiver l'animation.
	// En millisecondes.
	this.sidebarShowDuration = 250;

	// Durée de l'effet de transition entre images par défaut.
	// En millisecondes.
	this.transitionDuration = 500;

	// Effet de transition entre images par défaut.
	this.transitionEffect = 'fade';



	// Code minifié avec http://jscompress.com/
	this._anticsrf,this._autoDurationMouseDown=!1,this._autoTimer,this._carouselAnimation=!1,this._carouselCurrentPage=0,this._carouselCurrentPosition=1,this._carouselImages,this._carouselMaxThumbs=0,this._carouselMaxPosition=0,this._carouselNbPages=0,this._controlBarsAnimation=!1,this._controlBarsOver=!1,this._currentPosition,this._imageTransitionLock=!1,this._images={},this._init=!1,this._keyboardActive=!0,this._nbImages=0,this._prevDiaporamaSize,this._q,this._realsize=!1,this._sidebarMoveLock=!1,this.start=function(a,i){var t=this;if(""!==a){if("object"==typeof i)for(option in i)void 0!==this[option]&&"_"!=option.substr(1,1)&&(this[option]=i[option]);if(void 0===this._q&&(this._q=a),$("html,body").css("overflow","hidden"),$("#igalerie_gallery").hide(),this._init){if(this._q!=a){var e=a.match(/position\/(\d+)/);this._currentPosition=parseInt(e[1]),this._images={},this._nbImages=0,this._deleteImages(!0),this._realsize=!1,$("#diaporama_icon_switch img").attr("src",$("#diaporama_icon_switch img").attr("src").replace(/noresize(-grey)?\.png$/,"resize$1.png")),this._q=a,this._getImages(!0)}return $("#diaporama").show(),this._changeDiaporamaSize(),this._changeImageSizePosition(this._currentPosition,!1,!0),this._keyboardActive=!0,void(this.autoStart=diaporama_prefs.autoStart)}this._options(),$(window).resize(function(){t._resize()}),this._downloadImage(),this._sidebarsEvents(),this._favoritesBasketEvents(),this._closeDiaporama(),this._getImages(!0),this._autoAddDuration(),$("#diaporama").show(),this._bars(),this._changeDiaporamaSize(),this._changeLoadingPosition(0,!0),this._prevDiaporamaSize=this._getDiaporamaSize();var e=t._q.match(/position\/(\d+)/);this._currentPosition=parseInt(e[1]),this._keyboard(),this._autoEvents(),this._editSidebar(),this._init=!0}},this._alertError=function(a){""==a?a="unknown error.":a.length>500&&(a=a.slice(0,500)+"..."),alert("Error: "+a)},this._autoAddDuration=function(){var a=this.autoDuration.toString();a.match(/\./)||(a+=".0"),$("#diaporama_seconds").text(a+" s")},this._autoChangeDuration=function(a,i){var t=this;this._autoDurationMouseDown&&(i=i?i>20?i-5:i:170,this.autoDuration+a>=this.autoDurationMin&&this.autoDuration+a<=this.autoDurationMax&&(this.autoDuration=Math.round(10*(this.autoDuration+a))/10,this._autoAddDuration(),setTimeout(function(){t._autoChangeDuration(a,i)},i)),this._savePrefs())},this._autoChangeImage=function(a){var i=this;if(!$("#diaporama_icon_stop img").attr("src").match(/stop-active\.png$/)){a||(this._currentPosition!=this._nbImages?this._changeImage($("#diaporama_icon_next")):this.autoLoop&&this._changeImage($("#diaporama_icon_first")));var t="#diaporama_image_"+this._currentPosition,e=function(){$("#diaporama_loading").css("visibility","hidden");var t="none"==i.transitionEffect||a?0:parseInt(i.transitionDuration);i._autoTimer=setTimeout(function(){i._autoChangeImage()},1e3*i.autoDuration+t)};if($.browser.msie){var o=$(t).attr("src");$(t).attr("src",""),$(t).attr("src",o)}$("#diaporama_loading").css("visibility","visible"),$(t).one("load",function(){e()}).each(function(){(this.complete||4==this.readyState||"complete"==this.readyState)&&$(this).trigger("load")})}},this._autoEvents=function(){var a,i=this;$(".diaporama_messages").css("opacity",.9),$("#diaporama_icon_start").click(function(){$("#diaporama_icon_start img").attr("src").match(/start-active\.png$/)||i._nbImages<2||(i._currentPosition!=i._nbImages||i.autoLoop)&&($("#diaporama_icon_start img").attr("src",$("#diaporama_icon_start img").attr("src").replace(/start\.png$/,"start-active.png")),$("#diaporama_icon_stop img").attr("src",$("#diaporama_icon_stop img").attr("src").replace(/stop-active\.png$/,"stop.png")),clearTimeout(a),$("#diaporama_msg_stop").css("visibility","hidden"),$("#diaporama_msg_play").css("visibility","visible").fadeIn(1e3,function(){a=setTimeout(function(){$("#diaporama_msg_play").fadeOut(1e3)},2e3)}),i._autoChangeImage(!0))}),$("#diaporama_icon_stop").click(function(){$("#diaporama_icon_stop img").attr("src").match(/stop-active\.png$/)||(clearTimeout(i._autoTimer),i._autoTimer=void 0,clearTimeout(a),$("#diaporama_msg_play").css("visibility","hidden"),$("#diaporama_msg_stop").css("visibility","visible").fadeIn(1e3,function(){a=setTimeout(function(){$("#diaporama_msg_stop").fadeOut(1e3)},2e3)}),$("#diaporama_icon_stop img").attr("src",$("#diaporama_icon_stop img").attr("src").replace(/stop\.png$/,"stop-active.png")),$("#diaporama_icon_start img").attr("src",$("#diaporama_icon_start img").attr("src").replace(/start-active\.png$/,"start.png")))}),$("#diaporama_icon_more").mousedown(function(){i._autoDurationMouseDown=!0,i._autoChangeDuration(i.autoDurationPrecision)}).mouseup(function(){i._autoDurationMouseDown=!1}).focus(function(){$("#diaporama_icon_more").trigger("mouseover")}).blur(function(){$("#diaporama_icon_more").trigger("mouseout")}).mouseover(function(){$(this).find("img").attr("src",$(this).find("img").attr("src").replace(/more\.png$/,"more-hover.png"))}).mouseout(function(){$(this).find("img").attr("src",$(this).find("img").attr("src").replace(/more-hover\.png$/,"more.png"))}),$("#diaporama_icon_less").mousedown(function(){i._autoDurationMouseDown=!0,i._autoChangeDuration(-i.autoDurationPrecision)}).mouseup(function(){i._autoDurationMouseDown=!1}).focus(function(){$("#diaporama_icon_less").trigger("mouseover")}).blur(function(){$("#diaporama_icon_less").trigger("mouseout")}).mouseover(function(){$(this).find("img").attr("src",$(this).find("img").attr("src").replace(/less\.png$/,"less-hover.png"))}).mouseout(function(){$(this).find("img").attr("src",$(this).find("img").attr("src").replace(/less-hover\.png$/,"less.png"))})},this._bars=function(){var a,i,t,e=this;this.hideControlBars&&$(".diaporama_bar,#diaporama_carousel").hide(),$("#diaporama").mousemove(function(o){if(!(!e.hideControlBars||e._isSidebarVisible()||e._controlBarsOver||e._controlBarsAnimation||i==o.pageX&&t==o.pageY)){clearTimeout(a),i=o.pageX,t=o.pageY;var r=500;e._controlBarsAnimation=!0,setTimeout(function(){e._controlBarsAnimation=!1},r),$(".diaporama_bar"+(e.carousel?",#diaporama_carousel":"")).fadeIn(r),e.carousel&&e._changeCarouselSizePosition(),a=setTimeout(function(){if(e.hideControlBars&&!e._isSidebarVisible()&&!e._controlBarsOver){var a=1e3;e._controlBarsAnimation=!0,setTimeout(function(){e._controlBarsAnimation=!1},a),$(".diaporama_bar,#diaporama_carousel").fadeOut(a)}},1500)}}),$(".diaporama_bar,#diaporama_carousel").mouseover(function(){e._controlBarsOver=!0}).mouseout(function(){e._controlBarsOver=!1})},this._changeDiaporamaSize=function(){$("#diaporama").css({height:$(window).height()+"px",width:$(window).width()+"px"}),$(".diaporama_sidebar").css({height:$(window).height()-$("#diaporama_top").height()-$("#diaporama_bottom").height()+"px"}),this._changeCarouselSizePosition(),this._changeLoadingPosition()},this._changeImage=function(a,i){var t,e=this;switch(a=$(a).attr("id").replace(/diaporama_icon_/,"")){case"first":t=1;break;case"prev":t=this._currentPosition-1;break;case"next":t=this._currentPosition+1;break;case"last":t=this._nbImages}if(!(!$("#diaporama_image_"+t).is("img")||1>t||t>this._nbImages||this._imageTransitionLock||this._sidebarMoveLock)){this._realsize=!1,$("#diaporama_icon_switch img").attr("src",$("#diaporama_icon_switch img").attr("src").replace(/noresize(-grey)?\.png$/,"resize$1.png")),this._changeImageSizePosition(t);var o=this._currentPosition;this._currentPosition=t,this._transition(o,t,a),this._q=this._q.replace(/position\/\d+$/,"position/"+t),"none"==this.transitionEffect?this._getImages():setTimeout(function(){e._getImages()},this.transitionDuration),this._changeNavigationButtons(),this._changeSwitchButton(),"number"!=typeof this._autoTimer||t!=this._nbImages||this.autoLoop||$("#diaporama_icon_stop").trigger("click"),i&&"number"==typeof this._autoTimer&&(clearTimeout(this._autoTimer),this._autoTimer=void 0,this._autoChangeImage(!0))}},this._changeImageInfos=function(){if(void 0!==this._images[this._currentPosition]){$("#diaporama_image_position").text(this._images[this._currentPosition].current_image),$("#diaporama_top_left").html(this._images[this._currentPosition].image_position);var a=this._images[this._currentPosition],i=a.infos;if(void 0===i.desc.title?($("#diaporama_sidebar_desc").hide(),$("#diaporama_sidebar_desc .diaporama_sidebar_title2 span").empty()):($("#diaporama_sidebar_desc").show(),$("#diaporama_sidebar_desc .diaporama_sidebar_title2 span").text(i.desc.title),$("#diaporama_sidebar_desc .diaporama_sidebar_content p").html(i.desc.content)),void 0===i.stats.title)$("#diaporama_sidebar_stats").hide(),$("#diaporama_sidebar_stats .diaporama_sidebar_title2 span").empty(),$("#diaporama_sidebar_stats .diaporama_sidebar_content").empty();else{$("#diaporama_sidebar_stats").show(),$("#diaporama_sidebar_stats .diaporama_sidebar_title2 span").text(i.stats.title);var e="<ul>";for(stat in i.stats.items)e+="<li>"+i.stats.items[stat]+"</li>";e+="</ul>",$("#diaporama_sidebar_stats .diaporama_sidebar_content").html(e)}if(void 0===i.tags.title)$("#diaporama_sidebar_tags").hide(),$("#diaporama_sidebar_tags .diaporama_sidebar_title2 span").empty(),$("#diaporama_sidebar_tags .diaporama_sidebar_content").empty();else{$("#diaporama_sidebar_tags").show(),$("#diaporama_sidebar_tags .diaporama_sidebar_title2 span").text(i.tags.title);var e="<ul>";for(t in i.tags.items)e+='<li class="icon icon_tag"><a href="'+i.tags.items[t].tag_link+'">'+i.tags.items[t].tag_name+"</a></li>\n";e+="</ul>",$("#diaporama_sidebar_tags .diaporama_sidebar_content").html(e)}var o=["exif","iptc","xmp"];for(meta in o)if(void 0===i[o[meta]].title)$("#diaporama_sidebar_"+o[meta]).hide(),$("#diaporama_sidebar_"+o[meta]+" .diaporama_sidebar_title2 span").empty(),$("#diaporama_sidebar_"+o[meta]+" .diaporama_sidebar_content").empty();else{$("#diaporama_sidebar_"+o[meta]).show(),$("#diaporama_sidebar_"+o[meta]+" .diaporama_sidebar_title2 span").text(i[o[meta]].title);var e="<ul>";for(data in i[o[meta]].items)e+="<li><span>"+i[o[meta]].items[data].name+"</span> : "+i[o[meta]].items[data].value+"</li>";e+="</ul>",$("#diaporama_sidebar_"+o[meta]+" .diaporama_sidebar_content").html(e)}if($("#diaporama_edit").is("div")){if($("#diaporama_edit_urlname").val(a.image_url),$("#diaporama_edit_langs_select option").each(function(){$("#diaporama").append('<textarea style="display:none" id="diaporama_tatemp">'+a.locale.title[$(this).val()]+"</textarea>"),$("#diaporama_edit_title_"+$(this).val()).val($("#diaporama_tatemp").val()),$("#diaporama_tatemp").remove(),null===a.locale.desc[$(this).val()]?$("#diaporama_edit_description_"+$(this).val()).val(""):($("#diaporama").append('<textarea style="display:none" id="diaporama_tatemp">'+a.locale.desc[$(this).val()]+"</textarea>"),$("#diaporama_edit_description_"+$(this).val()).val($("#diaporama_tatemp").val()),$("#diaporama_tatemp").remove())}),void 0===i.tags.title)$("#diaporama_edit_tags").val("");else{for(var r=new Array,s=0;s<i.tags.items.length;s++)r[s]=i.tags.items[s].tag_name;$("#diaporama").append('<textarea style="display:none" id="diaporama_tatemp">'+r.join(", ")+"</textarea>"),$("#diaporama_edit_tags").val($("#diaporama_tatemp").val()),$("#diaporama_tatemp").remove()}1==this._images[this._currentPosition].perm_edit?($("#diaporama_edit").removeClass("diaporama_disabled"),$("#diaporama_edit input,#diaporama_edit textarea,#diaporama_edit select").removeAttr("disabled")):($("#diaporama_edit").addClass("diaporama_disabled"),$("#diaporama_edit input,#diaporama_edit textarea,#diaporama_edit select").attr("disabled","disabled"))}if($("#diaporama_icon_fav").is("a")){var n=$("#diaporama_icon_fav img").attr("src").replace(/(-active)?.png$/,"");this._images[this._currentPosition].in_favorites?(n+="-active.png",$("#diaporama_icon_fav").attr("title",diaporama_fav_del)):(n+=".png",$("#diaporama_icon_fav").attr("title",diaporama_fav_add)),$("#diaporama_icon_fav img").attr("src",n)}if($("#diaporama_icon_basket").is("a")){var n=$("#diaporama_icon_basket img").attr("src").replace(/(-active)?.png$/,"");this._images[this._currentPosition].in_basket?(n+="-active.png",$("#diaporama_icon_basket").attr("title",diaporama_basket_del)):(n+=".png",$("#diaporama_icon_basket").attr("title",diaporama_basket_add)),$("#diaporama_icon_basket img").attr("src",n)}this._changeCarouselCurrent()}},this._changeImageSizePosition=function(a,i,t,e,o){if(this._changeLoadingPosition(o),void 0!==this._images[a]&&$("#diaporama_image_"+a).is("img")){var r=this._getDiaporamaSize();r.aW+=o?o:0;var s=this._images[a].image_width/r.aW,n=this._images[a].image_height/r.aH,_=this._images[a].image_width,m=this._images[a].image_height,c=_,d=m;this._realsize||(_>r.aW&&s>=n&&(c=r.aW,d=m/s),m>r.aH&&n>=s&&(c=_/n,d=r.aH));{var h=$("#diaporama_image_"+a).offset();$("#diaporama_image_"+a).offset()}if(c<=r.aW||c!=$("#diaporama_image_"+a).width())h.left=(r.aW-c)/2;else if(c>r.aW&&r.aW!=this._prevDiaporamaSize.aW){h.left+=(r.aW-this._prevDiaporamaSize.aW)/2;var p=c-r.aW+h.left;0>p&&(h.left-=p),h.left>0&&(h.left=0),h.left=h.left}if(d<=r.aH||d!=$("#diaporama_image_"+a).height())h.top=(r.aH-d)/2+r.bTH;else if(d>r.aH&&r.aH!=this._prevDiaporamaSize.aH){h.top+=(r.aH-this._prevDiaporamaSize.aH)/2;var l=d-(r.aH+r.bBH+r.cH)+h.top;0>l&&(h.top-=l),h.top>r.bTH&&(h.top=r.bTH),h.top=h.top}var u={top:Math.round(h.top)+"px",left:Math.round(h.left)+"px",width:Math.round(c)+"px",height:Math.round(d)+"px"};return e||(i&&$("#diaporama_image_"+a).is(":visible")&&this.imageResizeDuration>0&&this.animate?$("#diaporama_image_"+a).animate(u,this.imageResizeDuration):$("#diaporama_image_"+a).css(u)),t&&$("#diaporama_image_"+a).show(),no_right_click&&$("#diaporama_image_"+a).bind("contextmenu",function(){return!1}),e?u:void(a==this._currentPosition&&this._changeSwitchButton())}},this._changeLoadingPosition=function(a,i){var t=this._getDiaporamaSize();if(t.aW+=a?a:0,$("#diaporama_loading").css({top:(t.aH-$("#diaporama_loading").height())/2+t.bTH+"px",left:(t.aW-$("#diaporama_loading").width())/2+"px"}),i){new Spinner({lines:8,length:0,width:16,radius:18,corners:1,rotate:0,color:"#fff",speed:1,trail:60,shadow:!1}).spin(document.getElementById("diaporama_loading"))}},this._changeNavigationButtons=function(){var a=this,i={first:1,prev:this._currentPosition<=2?1:this._currentPosition-1,next:this._currentPosition>=this._nbImages?this._nbImages:this._currentPosition+1,last:this._nbImages};for(button in i){var t="#diaporama_icon_"+button,e=new RegExp(button+"(?:-hover|-grey)?.png$");$(t).unbind(),void 0===this._images[i[button]]||this._currentPosition==i[button]?($(t+" img").attr("src",$(t+" img").attr("src").replace(e,button+"-grey.png")),$(t).removeAttr("href").css({cursor:"default"})):($(t+" img").attr("src").match(/-grey.png$/)&&$(t+" img").attr("src",$(t+" img").attr("src").replace(e,button+".png")),$(t).css({cursor:"pointer"}).focus(function(){$(this).trigger("mouseover")}).blur(function(){$(this).trigger("mouseout")}).mouseover(function(){var a=$(this).attr("id").replace(/diaporama_icon_/,"");$(this).find("img").attr("src",$(this).find("img").attr("src").replace(a+".png",a+"-hover.png"))}).mouseout(function(){var a=$(this).attr("id").replace(/diaporama_icon_/,"");$(this).find("img").attr("src",$(this).find("img").attr("src").replace(a+"-hover.png",a+".png"))}).click(function(){a._changeImage(this,!0)}))}},this._changeSwitchButton=function(){var a=this;if(void 0!==this._images[this._currentPosition]){var i=this._getDiaporamaSize();if($("#diaporama_icon_switch").unbind("click"),this._images[this._currentPosition].image_width>i.aW||this._images[this._currentPosition].image_height>i.aH){$("#diaporama_icon_switch").click(function(){a._realsize=!a._realsize,a._changeImageSizePosition(a._currentPosition,!0)});var t=this._realsize?"no":"";$("#diaporama_icon_switch img").attr("src",$("#diaporama_icon_switch img").attr("src").replace(/(no)?resize(-grey)?\.png$/,t+"resize.png")).css({cursor:"pointer"})}else $("#diaporama_icon_switch").removeAttr("href"),$("#diaporama_icon_switch img").attr("src",$("#diaporama_icon_switch img").attr("src").replace(/(no)?resize(-grey)?\.png$/,"resize-grey.png")).css({cursor:"default"});this._imageMouseDown()}},this._closeDiaporama=function(){var a=this;$("#diaporama_icon_close").click(function(){a._keyboardActive=!1,$("html").css("overflow","auto"),$("body").css("overflow","auto"),$("#diaporama_icon_stop").trigger("click"),$(".diaporama_messages").stop().hide(),$("#diaporama_edit .message").hide(),$("#igalerie_gallery").show(),$("#diaporama").hide(),$("#diaporama_image_"+a._currentPosition).hide()})},this._createImage=function(a){void 0===this._images[a]||$("#diaporama_image_"+a).is("img")||($("#diaporama").append('<img class="diaporama_image" id="diaporama_image_'+a+'" style="display:none;" src="'+this._images[a].image_src+'" alt="" />'),$.browser.mozilla&&$("#diaporama_image_"+a).css("outline","1px solid transparent"),a==this._currentPosition&&($.browser.msie?$("#diaporama_loading").css("visibility","hidden"):$("#diaporama_image_"+this._currentPosition).one("load",function(){$("#diaporama_loading").css("visibility","hidden")}).each(function(){this.complete&&$(this).trigger("load")})))},this._deleteImages=function(a){var i=this;$(".diaporama_image").each(function(){var t=$(this).attr("id").replace(/diaporama_image_/,"");(void 0===i._images[t]||a)&&$(this).remove()})},this._dragImage=function(a,i){var t=this._getDiaporamaSize(),e=a.offsetLeft,o=a.offsetTop,r=i.pageX,s=i.pageY;return $(document).mousemove(function(i){var n=i.pageX,_=i.pageY;return e+=n-r,o+=_-s,r=n,s=_,$(a).width()>t.aW?e>0?e=0:e<t.aW-$(a).width()&&(e=t.aW-$(a).width()):e=$(a).css("left"),$(a).height()>t.aH?o>t.bTH?o=t.bTH:o<$(window).height()-t.bBH-t.cH-$(a).height()-t.iBH&&(o=$(window).height()-t.bBH-t.cH-$(a).height()-t.iBH):o=$(a).css("top"),$(a).css({left:e+"px",top:o+"px"}),!1}),$(document).mouseup(function(){return $(document).unbind("mousemove mouseup"),!1}),!1},this._editSidebar=function(){if($("#diaporama_edit").is("div")){var a,i=this,t=function(i){$("#diaporama_edit .message").hide(),$("#diaporama_edit .message_error span").text(i),$("#diaporama_edit .message_error").show(),a=setTimeout(function(){$("#diaporama_edit .message_error").hide()},4e3)},e=function(){$("#diaporama_edit .message_success").show(),a=setTimeout(function(){$("#diaporama_edit .message_success").hide()},3e3)};$("#diaporama_edit_langs select").change(function(){var a=$(this).find(":selected").val();$("#diaporama_edit label.icon_lang").parents("p").hide(),$("#diaporama_edit label.icon_"+a).parents("p").show()}),$("#diaporama_edit form").submit(function(){return!1}),$("#diaporama_edit input.submit").click(function(){var o=$("#diaporama_edit form").serialize(),r=$("#diaporama_edit_tags").val(),s=$("#diaporama_edit_urlname").val();clearTimeout(a),$("#diaporama_edit .message").hide(),$("#diaporama_edit_loading").show(),$("#diaporama_edit input").attr("disabled","disabled"),$("#diaporama_edit textarea").attr("disabled","disabled"),$.post(gallery_path+"/ajax.php",{section:"edit-image",id:i._images[i._currentPosition].image_id,data:o,urlname:s,tags:r,anticsrf:i._anticsrf,q:q,q_md5:q_md5},function(a){switch($("#diaporama_edit_loading").hide(),$("#diaporama_edit input").removeAttr("disabled"),$("#diaporama_edit textarea").removeAttr("disabled"),a.status){case"nochange":$("#diaporama_edit .message").hide();break;case"success":e(),i._getImages(!1);break;case"warning":t(a.msg);break;case"error":i._alertError(a.msg)}},"json")})}},this._downloadImage=function(){var a=this;$("#diaporama_icon_download").click(function(){window.location=gallery_path+"/download.php?img="+a._images[a._currentPosition].image_id})},this._favoritesBasketEvents=function(){for(var a=this,i=["fav","basket"],t=0;t<i.length;t++)$("#diaporama_icon_"+i[t]).click(function(){if(void 0!==a._images[a._currentPosition]){var i=$(this).attr("id"),t=i.match(/fav$/)?"fav":"basket",e=$("#diaporama_icon_"+t+" img").attr("src").match(/-active/)?"-remove":"-add";$.post(gallery_path+"/ajax.php",{anticsrf:a._anticsrf,section:(i.match(/fav$/)?"favorites":"basket")+e,images_id:a._images[a._currentPosition].image_id,q:q,q_md5:q_md5},function(t){if(null!=t)switch(t.status){case"error":a._alertError(t.msg);break;case"full":alert(t.msg);break;case"success":var e=i.match(/basket$/)&&a._q.match(/^basket/)||i.match(/fav$/)&&a._q.match(/^user-favorites/)?!1:!0;a._getImages(!1,e)}},"json")}})},this._getCarousel=function(a){if(this.carousel){var i=this,t=a?this._q.replace(/\d+$/,a):this._q;this._carouselCurrentPosition=a?a:this._currentPosition,$.post(gallery_path+"/ajax.php?q="+t,{section:"carousel",size:this.carouselThumbsSize},function(a){if("object"==typeof a&&null!==a)switch(a.status){case"error":i._alertError(a.msg);break;case"no_result":break;default:if(i._carouselImages=a.images,a.nb_images!=i.nbImages&&$("#diaporama_carousel_thumbs").empty(),void 0===i._carouselImages[i._carouselCurrentPosition]&&a.nb_images>0){i._reload(a.nb_images);break}i.nbImages=a.nb_images,i._changeCarouselImages()}},"json")}},this._getCarouselStart=function(){var a=Math.floor(this._carouselMaxThumbs)-1;return(Math.ceil(this._carouselCurrentPosition/a)-1)*a+1},this._changeCarouselCurrent=function(){this.carousel&&($("#diaporama_carousel_thumbs dl").removeClass("current"),$("#diaporama_carousel_image_"+this._currentPosition).addClass("current"))},this._changeCarouselImages=function(a){if(void 0!==this._carouselImages){if(this._currentPosition>=this._carouselMaxPosition){var i,t,e,o="",r=0,s=this,n=Math.floor(this._carouselMaxThumbs)-1,_=Math.ceil(this._carouselMaxThumbs),m=this._getCarouselStart();if(m==this._nbImages&&(m-=n,1>m&&(m=1)),this.animate||(a=!1),a){this._carouselAnimation=!0,this._carouselCurrentPosition=m;var c=(this._getDiaporamaSize(),n*(this.carouselThumbsSize+2*this.carouselThumbsBorder+this.carouselThumbsMargin));"prev"==a?$("#diaporama_carousel_thumbs dl:gt("+(_-n)+")").addClass("old"):$("#diaporama_carousel_thumbs dl:lt("+n+")").addClass("old")}else{var d=$("#diaporama_carousel_thumbs dl").length?parseInt($("#diaporama_carousel_thumbs dl:first").attr("id").replace(/diaporama_carousel_image_(\d+)/,"$1")):m;d!=m&&$("#diaporama_carousel_thumbs").empty()}for(p in this._carouselImages)if(!(p<m||$("#diaporama_carousel_image_"+p).is("dl"))){if("prev"==a&&r==n)break;if(r++,t=this.carouselThumbsSize,e=this.carouselThumbsSize,i=this._carouselImages[p].thumb_center,o+='<dl id="diaporama_carousel_image_'+p+'"><dt style="width:'+t+'px"><a rel="'+r+'" class="thumb_link" style="width:'+t+"px;height:"+e+'px;"><img width="'+this._carouselImages[p].thumb_width+'" height="'+this._carouselImages[p].thumb_height+'" style="padding:'+this._carouselImages[p].thumb_center+'" src="'+this._carouselImages[p].thumb_src+'" /></a></dt></dl>\n',this._carouselMaxPosition=p,r==_)break}if("prev"==a?$("#diaporama_carousel_thumbs").css({"margin-left":"-"+c+"px"}).prepend(o):""!==o&&$("#diaporama_carousel_thumbs").append(o),a){var h="prev"==a?{"margin-left":0}:{"margin-left":"-"+c+"px"};$("#diaporama_carousel_thumbs").animate(h,this.carouselNavDuration,"swing",function(){$("#diaporama_carousel_thumbs dl.old").remove(),$("#diaporama_carousel_thumbs").css("margin-left",0),s._getCarousel(s._carouselCurrentPosition),s._carouselAnimation=!1})}$("#diaporama_carousel_thumbs dl").click(function(){var a=parseInt($(this).attr("id").replace(/diaporama_carousel_image_(\d+)/,"$1")),i=s._nbImages;a!=s._currentPosition&&(s.autoStart=!1,s._reload(a),s._changeCarouselCurrent(),s._getCarouselStart()!=i&&($(this).find("a").attr("rel")>=Math.floor(s._carouselMaxThumbs)&&(s._carouselMaxPosition=0,s._getCarousel()),"number"==typeof s._autoTimer&&(a!=i||s.autoLoop?(clearTimeout(s._autoTimer),s._autoTimer=void 0,s._autoTimer=setTimeout(function(){s._autoChangeImage()},1e3*s.autoDuration)):$("#diaporama_icon_stop").trigger("click"))))}),this._changeCarouselPages()}a||this._changeCarouselCurrent()}},this._changeCarouselPages=function(){var a=this,i=Math.floor(this._carouselMaxThumbs)-1;this._carouselCurrentPage=Math.ceil(this._carouselCurrentPosition/i),this._carouselNbPages=Math.ceil((this._nbImages-1)/i),this._carouselCurrentPage>1?$("#diaporama_carousel_prev a").addClass("active").unbind().click(function(){if(!a._carouselAnimation){var i=$("#diaporama_carousel_thumbs dl:first").attr("id");if(i){var t=parseInt(i.replace(/diaporama_carousel_image_/,""))-1;a._carouselMaxPosition=0,a._carouselCurrentPosition=t,a._changeCarouselImages("prev")}}}):$("#diaporama_carousel_prev a").removeAttr("href").unbind().removeClass(),this._carouselCurrentPage<this._carouselNbPages?$("#diaporama_carousel_next a").addClass("active").unbind().click(function(){if(!a._carouselAnimation){var i=Math.floor(a._carouselMaxThumbs)-1,t=$("#diaporama_carousel_thumbs dl:eq("+i+")").attr("id");if(t){var e=parseInt(t.replace(/diaporama_carousel_image_/,""));a._carouselMaxPosition=0,a._carouselCurrentPosition=e,a._changeCarouselImages("next")}}}):$("#diaporama_carousel_next a").removeAttr("href").unbind().removeClass()},this._changeCarouselSizePosition=function(a){var i=this,t=this._getDiaporamaSize();t.aW+=a?a:0;var e={left:t.aW-$("#diaporama_carousel_prev").outerWidth()+"px"},o=function(){i._carouselMaxThumbs=(t.aW-2*$("#diaporama_carousel_prev").outerWidth()-i.carouselThumbsMargin)/(i.carouselThumbsSize+2*i.carouselThumbsBorder+i.carouselThumbsMargin),i._carouselMaxPosition=0,i._changeCarouselImages()},r=2*this.carouselThumbsMargin+2*this.carouselThumbsBorder+this.carouselBorderTop;$("#diaporama_carousel").css({height:this.carouselThumbsSize+r+"px"}),a&&this.animate?$("#diaporama_carousel_next").animate(e,this.sidebarShowDuration,function(){o()}):($("#diaporama_carousel_next").css(e),o())},this._getDiaporamaSize=function(){var a={bBH:0,bTH:0,cH:0,sW:0,iBH:0,iBW:0};return this.sidebarImageResize&&$(".diaporama_sidebar").is(":visible")&&(a.sW=$(".diaporama_sidebar").outerWidth()),this.carousel&&!this.hideControlBars&&(a.cH=$("#diaporama_carousel").outerHeight()),this.hideControlBars||(a.bTH=$("#diaporama_top").outerHeight(),a.bBH=$("#diaporama_bottom").outerHeight()),a.iBH=parseInt($("#diaporama_image_"+this._currentPosition).css("borderTopWidth"))+parseInt($("#diaporama_image_"+this._currentPosition).css("borderBottomWidth")),a.iBW=parseInt($("#diaporama_image_"+this._currentPosition).css("borderLeftWidth"))+parseInt($("#diaporama_image_"+this._currentPosition).css("borderRightWidth")),isNaN(a.iBH)&&(a.iBH=0),isNaN(a.iBW)&&(a.iBW=0),a.aH=$(window).height()-a.bTH-a.bBH-a.cH-a.iBH,a.aW=$(window).width()-a.sW-a.iBW,a},this._getImages=function(first,only_image_infos){var This=this;first&&$("#diaporama_loading").css("visibility","visible"),$.post(gallery_path+"/ajax.php?q="+this._q,{section:"diaporama",first:first?1:0,preload:this.preload},function(r){if("object"==typeof r&&null!==r)switch(r.status){case"error":This._alertError(r.msg);break;case"no_result":break;default:var reload=!1;if(only_image_infos){This._images=r.images,This._changeImageInfos();break}0==r.nb_images&&($("#diaporama_top_left,#diaporama_image_position,.diaporama_sidebar_inner").empty(),$("#diaporama_icon_switch").removeAttr("href"),$("#diaporama_icon_switch img").attr("src",$("#diaporama_icon_switch img").attr("src").replace(/(no)?resize(-grey)?\.png$/,"resize-grey.png")).css({cursor:"default"}),$("#diaporama_icon_fav img").attr("src",$("#diaporama_icon_fav img").attr("src").replace(/fav(-active)?.png$/,"fav.png")),$("#diaporama_icon_basket img").attr("src",$("#diaporama_icon_basket img").attr("src").replace(/basket(-active)?.png$/,"basket.png")),This._carouselImages=void 0,$("#diaporama_carousel_thumbs").empty(),$("#diaporama_carousel_prev a,#diaporama_carousel_next a").removeAttr("href").unbind().removeClass());for(p in r.images)if(void 0!==This._images[p]&&This._images[p].md5!=r.images[p].md5){This._currentPosition>r.nb_images&&(This._currentPosition=r.nb_images),This._deleteImages(!0),reload=!0;break}This._anticsrf=r.anticsrf,This._images=r.images,This._nbImages=r.nb_images,first&&0==r.max_user_connections&&0!=This.createImageTempTime&&(This.createImageTempTime=50);var i=1,temp_autostart=1;for(p in This._images){var visible=p==This._currentPosition;(first||reload||!visible)&&(first||reload?visible?(This._changeImageInfos(),This._createImage(p),This._changeImageSizePosition(p,!1,visible),temp_autostart=i):(eval("var create_"+p+" = function(){This._createImage("+p+");This._changeImageSizePosition("+p+", false, "+visible+");};setTimeout(create_"+p+", "+This.createImageTempTime+" * i);"),i++):(This._createImage(p),This._changeImageSizePosition(p,!1,visible)))}first||reload?setTimeout(function(){This._changeNavigationButtons()},This.createImageTempTime*temp_autostart):This._changeNavigationButtons(),reload&&$("#diaporama_carousel_thumbs").empty(),This._deleteImages(),first&&This.autoStart&&setTimeout(function(){$("#diaporama_icon_start").trigger("click")},This.createImageTempTime*temp_autostart),This._changeImageInfos(),This._carouselMaxPosition=0,This._getCarousel(This._currentPosition)}},"json")},this._getPrefs=function(){if("object"==typeof diaporama_prefs)for(name in diaporama_prefs)this[name]=diaporama_prefs[name]},this._imageMouseDown=function(){var a=this,i=$("#diaporama_image_"+this._currentPosition);i.unbind("mousedown"),$("#diaporama_icon_switch img").attr("src").match(/noresize\.png$/)?i.css({cursor:"move"}).mousedown(function(i){return a._dragImage(this,i)}):i.css({cursor:"default"})},this._isSidebarVisible=function(){var a=!1;return $(".diaporama_sidebar").each(function(){return $(this).is(":visible")?void(a=!0):void 0}),a},this._keyboard=function(){if(this.keyboardNav){var a=this;$("#diaporama select, #diaporama input, #diaporama textarea").focus(function(){a._keyboardActive=!1}).blur(function(){a._keyboardActive=!0}),$(document).keyup(function(i){if(a._keyboardActive)switch(i.keyCode){case 27:$("#diaporama_icon_close").trigger("click");break;case 32:$("#diaporama_icon_stop img").attr("src").match(/stop-active\.png$/)?$("#diaporama_icon_start").trigger("click"):$("#diaporama_icon_stop").trigger("click");break;case 37:$("#diaporama_icon_prev").trigger("click");break;case 39:$("#diaporama_icon_next").trigger("click")}}),$(document).keydown(function(i){if(a._keyboardActive)switch(i.keyCode){case 38:a._autoDurationMouseDown=!0,a._autoChangeDuration(a.autoDurationPrecision),a._autoDurationMouseDown=!1;break;case 40:a._autoDurationMouseDown=!0,a._autoChangeDuration(-a.autoDurationPrecision),a._autoDurationMouseDown=!1}})}},this._options=function(){var a=this;this._getPrefs(),$("#diaporama_carousel_option").click(function(){a.carousel=!a.carousel,a.carousel?(a._getCarousel(),$("#diaporama_carousel").show(),a._changeCarouselSizePosition()):$("#diaporama_carousel").hide(),a._changeImageSizePosition(a._currentPosition),a._prevDiaporamaSize=a._getDiaporamaSize(),a._savePrefs()}),this.carousel?($("#diaporama_carousel_option").attr("checked","checked"),$("#diaporama_carousel").show()):($("#diaporama_carousel_option").removeAttr("checked"),$("#diaporama_carousel").hide()),this.carouselThumbsSize=this.carouselThumbsSize<50?50:this.carouselThumbsSize,$("#diaporama_transitions_effect").change(function(){a.transitionEffect=$("#diaporama_transitions_effect option:selected").val(),a._savePrefs()}),$("#diaporama_transitions_effect option[value="+this.transitionEffect+"]").attr("selected","selected"),$("#diaporama_transitions_duration").keyup(function(){a.transitionDuration=$("#diaporama_transitions_duration").val(),a._savePrefs()}),$("#diaporama_transitions_duration").val(this.transitionDuration),$("#diaporama_autoloop").click(function(){a.autoLoop=!a.autoLoop,a._currentPosition!=a._nbImages||a.autoLoop||$("#diaporama_icon_stop").trigger("click"),a._savePrefs()}),this.autoLoop?$("#diaporama_autoloop").attr("checked","checked"):$("#diaporama_autoloop").removeAttr("checked"),$("#diaporama_hidebars").click(function(){a.hideControlBars=!a.hideControlBars,a._changeImageSizePosition(a._currentPosition),a._savePrefs()}),this.hideControlBars?$("#diaporama_hidebars").attr("checked","checked"):$("#diaporama_hidebars").removeAttr("checked"),$("#diaporama_animate").click(function(){a.animate=!a.animate,a._savePrefs()}),this.animate?$("#diaporama_animate").attr("checked","checked"):$("#diaporama_animate").removeAttr("checked")},this._reload=function(a){this._q=this._q.replace(/position\/\d+$/,"position/"+a),this._currentPosition=a,this._images={},this._nbImages=0,this._realsize=!1,this._changeNavigationButtons(),this._deleteImages(!0),this._getImages(!0,!1)},this._resize=function(){this._changeDiaporamaSize(),void 0!==this._images[this._currentPosition]&&this._changeImageSizePosition(this._currentPosition),this._prevDiaporamaSize=this._getDiaporamaSize()},this._savePrefs=function(){var a=this.animate+","+this.autoDuration+","+this.autoLoop+","+this.carousel+","+this.hideControlBars+","+this.transitionDuration+","+this.transitionEffect;$.post(gallery_path+"/ajax.php",{section:"prefs",cookie_param:"diaporama",cookie_value:a})},this._sidebarsEvents=function(){var a=this,i="#diaporama_top_right .diaporama_icon_sidebar";$(i).each(function(){var t="#"+$(this).attr("id"),e=t.replace(/_icon/,"");$(t).click(function(){if(!a._sidebarMoveLock&&!a._imageTransitionLock){a._sidebarMoveLock=!0;var o=a.sidebarImageResize?$(".diaporama_sidebar").outerWidth():0;if($(e).is(":hidden")){var r=!1,s=function(){var i=a._changeImageSizePosition(a._currentPosition,!0,!0,!0,-o),r=function(){a._prevDiaporamaSize=a._getDiaporamaSize(),a._changeSwitchButton(),a._sidebarMoveLock=!1,$(e).find("p:visible .diaporama_focus:not(:disabled)").focus()};a._changeCarouselSizePosition(-o),a.sidebarShowDuration&&a.animate?($("#diaporama_image_"+a._currentPosition).animate(i,a.sidebarShowDuration),$(e).show("slide",{direction:"right"},a.sidebarShowDuration,r)):($("#diaporama_image_"+a._currentPosition).css(i),$(e).show(),r()),$(t+" img").attr("src",$(t+" img").attr("src").replace(/\.png$/,"-active.png"))};$(i).each(function(){var i="#"+$(this).attr("id").replace(/_icon/,"");$(i).is(":visible")&&($(this).find("img").attr("src",$(this).find("img").attr("src").replace(/-active\.png$/,".png")),a.sidebarShowDuration&&a.animate?$(i).hide("slide",{direction:"right"},a.sidebarShowDuration,s):($(i).hide(),s()),r=!0)}),r||s()}else{var n=a._changeImageSizePosition(a._currentPosition,!0,!0,!0,o),_=function(){a._prevDiaporamaSize=a._getDiaporamaSize(),a._changeSwitchButton(),a._sidebarMoveLock=!1};a._changeCarouselSizePosition(o),a.sidebarShowDuration&&a.animate?($("#diaporama_image_"+a._currentPosition).animate(n,a.sidebarShowDuration),$(e).hide("slide",{direction:"right"},a.sidebarShowDuration,_)):($("#diaporama_image_"+a._currentPosition).css(n),$(e).hide(),_()),$(t+" img").attr("src",$(t+" img").attr("src").replace(/-active\.png$/,".png")),$(t).focus()}}})}),$(".diaporama_sidebar_close").click(function(){var a="#"+$(this).parents("div").attr("id").replace(/diaporama/,"diaporama_icon");$(a).trigger("click")}),$(".diaporama_sidebar_title2 span").click(function(){var a=$(this).parents("li").find(".diaporama_sidebar_content");a.is(":hidden")?a.slideDown("fast"):a.slideUp("fast")})},this._transition=function(a,i,t){var e=this,o=this._getDiaporamaSize(),r=$("#diaporama_image_"+a).offset(),s=parseInt(this.transitionDuration),n=this.transitionEffect;if(this._imageTransitionLock=!0,"random"==this.transitionEffect){var _=$("#diaporama_transitions_effect option").length-2,m=Math.floor(Math.random()*_)+1;n=document.getElementById("diaporama_transitions_effect").getElementsByTagName("option")[m].value}switch(n){case"fade":$("#diaporama_image_"+a).fadeOut(s),$("#diaporama_image_"+i).fadeIn(s);break;case"slideX":case"slideY":var c={},d={display:"none"};"slideX"==n?(c.left="next"==t||"last"==t?r.left-o.aW+"px":r.left+o.aW+"px",d.left=r.left+"px"):(c.top="next"==t||"last"==t?r.top+o.aH+"px":r.top-o.aH+"px",d.top=r.top+"px"),$("#diaporama_image_"+a).animate(c,s,"swing",function(){$("#diaporama_image_"+a).css(d)});var h={display:"block"},p={};if("slideX"==n){var l=$("#diaporama_image_"+i).css("left");p.left=l,h.left="next"==t||"last"==t?parseFloat(l)+o.aW+"px":parseFloat(l)-o.aW+"px"}else{var u=$("#diaporama_image_"+i).css("top");p.top=u,h.top="next"==t||"last"==t?parseFloat(u)-o.aH+"px":parseFloat(u)+o.aH+"px"}$("#diaporama_image_"+i).css(h).animate(p,s,"swing");break;case"slideXLeft":case"slideYBottom":var c={},d={display:"none"};"slideXLeft"==n?(c.left=r.left-o.aW+"px",d.left=r.left+"px"):(c.top=r.top+o.aH+"px",d.top=r.top+"px"),$("#diaporama_image_"+a).animate(c,s/2,"swing",function(){$("#diaporama_image_"+a).css(d);var t={display:"block"},e={};if("slideXLeft"==n){var r=$("#diaporama_image_"+i).css("left");e.left=r,t.left=-(parseFloat(r)+o.aW)+"px"}else{var _=$("#diaporama_image_"+i).css("top");e.top=_,t.top=parseFloat(_)+o.aH+"px"}$("#diaporama_image_"+i).css(t).animate(e,s/2,"swing")});break;case"zoom":case"curtainX":case"curtainY":var c={},d={display:"none"};"curtainX"!=n&&(c.height=0,c.top=o.aH/2,d.top=r.top+"px"),"curtainY"!=n&&(c.width=0,c.left=o.aW/2,d.left=r.left+"px"),$("#diaporama_image_"+a).animate(c,s/2,"swing",function(){$("#diaporama_image_"+a).css(d);var t={display:"block"},e={};"curtainX"!=n&&(e.height=$("#diaporama_image_"+i).height(),e.top=$("#diaporama_image_"+i).css("top"),t.top=o.aH/2,t.height=0),"curtainY"!=n&&(e.width=$("#diaporama_image_"+i).width(),e.left=$("#diaporama_image_"+i).css("left"),t.left=o.aW/2,t.width=0),$("#diaporama_image_"+i).css(t).animate(e,s/2,"swing")});break;case"puff":var c={},d={display:"none",opacity:1};c.height=1.5*$("#diaporama_image_"+a).height(),c.width=1.5*$("#diaporama_image_"+a).width(),c.left=(o.aW-c.width)/2,c.top=(o.aH-c.height)/2+o.bTH,c.opacity=0,$("#diaporama_image_"+a).animate(c,s/2,"swing",function(){$("#diaporama_image_"+a).css(d);var t={display:"block"};t.height=1.5*$("#diaporama_image_"+i).height(),t.width=1.5*$("#diaporama_image_"+i).width(),t.left=(o.aW-t.width)/2,t.top=(o.aH-t.height)/2+o.bTH,t.opacity=0;var r=e._changeImageSizePosition(i,!0,!0,!0);r.opacity=1,$("#diaporama_image_"+i).css(t).animate(r,s/2,"swing")});break;default:$("#diaporama_image_"+a).hide(),$("#diaporama_image_"+i).show(),s=0}setTimeout(function(){e._changeImageInfos(),e._imageTransitionLock=!1},s)};
};